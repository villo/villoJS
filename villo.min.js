// Copyright (c) 2012 Villo Services

(function(window,undefined){villo=window.villo||{};villo.apiKey="";villo.version="0.9.9 p1";})(window);(function(){})();(function(){villo.chat={rooms:[],join:function(chatObject){if('PUBNUB'in window){if(villo.chat.isSubscribed(chatObject.room)==false){PUBNUB.subscribe({channel:"VILLO/CHAT/"+villo.app.id.toUpperCase()+"/"+chatObject.room.toUpperCase(),callback:function(message){chatObject.callback(message);},connect:chatObject.connect||function(){},error:function(e){}});if(chatObject.presence&&chatObject.presence.enabled&&chatObject.presence.enabled==true){villo.presence.join({room:chatObject.room,callback:(chatObject.presence.callback||"")});villo.chat.rooms.push({"name":chatObject.room.toUpperCase(),"presence":true});}else{villo.chat.rooms.push({"name":chatObject.room.toUpperCase(),"presence":false});}
return true;}else{return true;}}else{return false;}},isSubscribed:function(roomString){var c=false;for(x in villo.chat.rooms){if(villo.chat.rooms.hasOwnProperty(x)){if(villo.chat.rooms[x].name.toUpperCase()==roomString.toUpperCase()){c=true;}}}
return c;},send:function(messageObject){if('PUBNUB'in window){var pushMessage={"username":villo.user.username,"message":messageObject.message};if(!messageObject.room){messageObject.room=villo.chat.rooms[0].name;}
PUBNUB.publish({channel:"VILLO/CHAT/"+villo.app.id.toUpperCase()+"/"+messageObject.room.toUpperCase(),message:pushMessage});return true;}else{return false;}},leaveAll:function(){if('PUBNUB'in window){for(x in villo.chat.rooms){if(villo.chat.rooms.hasOwnProperty(x)){PUBNUB.unsubscribe({channel:"VILLO/CHAT/"+villo.app.id.toUpperCase()+"/"+villo.chat.rooms[x].name.toUpperCase()});if(villo.chat.rooms[x].presence&&villo.chat.rooms[x].presence==true){villo.presence.leave({room:villo.chat.rooms[x].name});}}}
villo.chat.rooms=[];return true;}else{return false;}},leave:function(closerObject){if('PUBNUB'in window){PUBNUB.unsubscribe({channel:"VILLO/CHAT/"+villo.app.id.toUpperCase()+"/"+closerObject.toUpperCase()});var x;for(x in villo.chat.rooms){if(villo.chat.rooms.hasOwnProperty(x)){if(villo.chat.rooms[x].name==closerObject){var rmv=x;if(villo.chat.rooms[x].presence&&villo.chat.rooms[x].presence==true){villo.presence.leave({room:villo.chat.rooms[x].name});}}}}
villo.chat.rooms.splice(rmv,1);return true;}else{return false;}},history:function(historyObject){if('PUBNUB'in window){PUBNUB.history({channel:"VILLO/CHAT/"+villo.app.id.toUpperCase()+"/"+historyObject.room.toUpperCase(),limit:(historyObject.limit||25),callback:function(data){historyObject.callback(data);}});}}}})();(function(){villo.clipboard={copy:function(string){var newIndex=villo.app.clipboard.length;villo.app.clipboard[newIndex]=string;return newIndex;},paste:function(index){if(index){return villo.app.clipboard[index];}else{var lastIndex=villo.app.clipboard.length;return villo.app.clipboard[lastIndex-1];}}}})();(function(){villo.feeds={post:function(pubObject){villo.ajax("https://api.villo.me/feeds.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"post",username:villo.user.username,token:villo.user.token,description:pubObject.description,action:pubObject.action||"user-post"},onSuccess:function(transport){if(transport==="1"){pubObject.callback(true);}else{pubObject.callback(33);}},onFailure:function(err){pubObject.callback(33);}});},repost:function(repostObject){return false;},get:function(){return false;},search:function(searchObject){villo.ajax("https://api.villo.me/feeds.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"search",username:villo.user.username,token:villo.user.token,limit:searchObject.limit||50,term:searchObject.term},onSuccess:function(transport){try{transport=JSON.parse(transport);}catch(e){}
if(transport&&transport.feeds){searchObject.callback(transport);}else{searchObject.callback(33);}},onFailure:function(err){searchObject.callback(33);}});},history:function(historyObject){villo.ajax("https://api.villo.me/feeds.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"history",username:villo.user.username,token:villo.user.token,limit:historyObject.limit||50,historyType:historyObject.type||"public",after:historyObject.after||false},onSuccess:function(transport){try{transport=JSON.parse(transport);}catch(e){}
if(transport&&transport.feeds){historyObject.callback(transport);}else{historyObject.callback(33);}},onFailure:function(err){historyObject.callback(33);}});},listen:function(listenObject){var feedString="VILLO/FEEDS/";if(!listenObject.type){listenObject.type="public";}
var h=listenObject.type;if(h.toLowerCase()==="public"){feedString+="PUBLIC";}else if(h.toLowerCase()==="user"||h.toLowerCase()==="username"){feedString+=("USERS/"+(listenObject.username.toUpperCase()||villo.user.getUsername().toUpperCase()));}else if(h.toLowerCase()==="apps"){feedString+=("APPS/"+(listenObject.appid.toUpperCase()||villo.app.id));}
PUBNUB.subscribe({channel:feedString,callback:function(data){listenObject.callback(data);}});}};})();(function(){villo.friends={add:function(addObject){villo.ajax("https://api.villo.me/friends.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"add",username:villo.user.username,token:villo.user.token,addUsername:addObject.username},onSuccess:function(transport){villo.verbose&&villo.log(transport);if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.friends){addObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){addObject.callback(transport);}else{addObject.callback(33);}}else{addObject.callback(33);}},onFailure:function(){addObject.callback(33);}});},remove:function(removeObject){villo.ajax("https://api.villo.me/friends.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"remove",username:villo.user.username,token:villo.user.token,removeUsername:removeObject.username},onSuccess:function(transport){villo.verbose&&villo.log(transport);if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.friends){removeObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){removeObject.callback(transport);}else{removeObject.callback(33);}}else{removeObject.callback(33);}},onFailure:function(){removeObject.callback(33);}});},get:function(getObject){villo.ajax("https://api.villo.me/friends.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"get",username:villo.user.username,token:villo.user.token},onSuccess:function(transport){villo.verbose&&villo.log(transport)
if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.friends){getObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){getObject.callback(transport);}else{getObject.callback(33);}}else{getObject.callback(33);}},onFailure:function(){getObject.callback(33);}});}}})();(function(){villo.gift={retrieve:function(giftObject){villo.ajax("https://api.villo.me/gifts.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:'specific',category:giftObject.categoryStack},onSuccess:function(transport){villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.gifts){giftObject.callback(tmprsp);}else{if(transport==33||transport==66||transport==99){giftObject.callback(transport);}else{giftObject.callback(33);}}}else{giftObject.callback(99);}},onFailure:function(failure){villo.log("failure!");giftObject.callback(33);}});},getCatagories:function(){villo.gift.getCategories(arguments);},getCategories:function(giftObject){villo.ajax("https://api.villo.me/gifts.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:'category'},onSuccess:function(transport){villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.gifts){giftObject.callback(tmprsp);}else{if(transport==33||transport==66||transport==99){giftObject.callback(transport);}else{giftObject.callback(33);}}}else{giftObject.callback(33);}},onFailure:function(failure){villo.log("failure!");giftObject.callback(33);}});},buy:function(giftObject){villo.ajax("https://api.villo.me/gifts.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:'buy',username:villo.user.username,token:villo.user.token,buyID:giftObject.giftID},onSuccess:function(transport){villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.gifts){giftObject.callback(tmprsp);}
if(transport==33||transport==66||transport==99){giftObject.callback(transport);}else{giftObject.callback(33);}}else{giftObject.callback(33);}},onFailure:function(failure){villo.log("failure!");giftObject.callback(33);}});},credits:function(giftObject){villo.log(villo.user.token);villo.log("Gettin' it!!");villo.ajax("https://api.villo.me/gifts.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:'checkCredit',username:villo.user.username,token:villo.user.token},onSuccess:function(transport){villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.gifts){villo.credits=tmprsp.gifts.data;giftObject.callback(tmprsp);}
if(transport==33||transport==66||transport==99){giftObject.callback(transport);}else{giftObject.callback(33);}}else{giftObject.callback(33);}},onFailure:function(failure){villo.log("failure!");giftObject.callback(33);}});},purchases:function(giftObject){villo.ajax("https://api.villo.me/gifts.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:'purchases',username:villo.user.username,token:villo.user.token},onSuccess:function(transport){villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.gifts){villo.credits=tmprsp.gifts.data;giftObject.callback(tmprsp);}
if(transport==33||transport==66||transport==99){giftObject.callback(transport);}else{giftObject.callback(33);}}else{giftObject.callback(33);}},onFailure:function(failure){giftObject.callback(33);}});}}})();(function(){villo.isLoaded=false;villo.verbose=false;villo.resource=function(options){if(options&&typeof(options)==="object"&&options.resources){var o=options.resources;var scripts=[];for(var x in o){if(o[x].slice(-3)=="css"){villo.style.add(o[x]);}else if(o[x].slice(-2)=="js"){scripts.push(o[x]);}else{if(o[x].slice(-1)=="/"){scripts.push(o[x]+"info.villo.js");}else{scripts.push(o[x]+"/info.villo.js");}}}
var callback=options.callback||function(){};$script(scripts,callback);}};villo.load=function(options){if(villo.isLoaded===true){if(options.forceReload&&options.forceReload===true){}else{villo.resource(options);return true;}}
if(options.api){villo.apiKey=options.api;}
if(options.useCookies&&options.useCookies===true){villo.overrideStorage(true);}
villo.app.platform=options.platform||"";villo.app.title=options.title||"";villo.app.id=options.id||"";villo.app.version=options.version||"";villo.app.developer=options.developer||"";if(!villo.user.propBag){villo.user.propBag={}}
villo.user.propBag.user="token.user."+villo.app.id.toUpperCase();villo.user.propBag.token="token.token."+villo.app.id.toUpperCase();if(!villo.app.propBag){villo.app.propBag={}}
villo.app.propBag.states="VAppState."+villo.app.id.toUpperCase();villo.app.propBag.settings="VilloSettingsProp."+villo.app.id.toUpperCase();if(store.get(villo.app.propBag.settings)){villo.settings.load({callback:villo.doNothing});}
if(options.verbose){villo.verbose=options.verbose;}
if(store.get(villo.user.propBag.user)&&store.get(villo.user.propBag.token)){villo.user.strapLogin({username:store.get(villo.user.propBag.user),token:store.get(villo.user.propBag.token)});villo.sync();}else{}
if(options.extensions&&(typeof(options.extensions=="object"))&&options.extensions.length>0){var extensions=[];for(x in options.extensions){if(options.extensions.hasOwnProperty(x)){extensions.push(villo.script.get()+options.extensions[x]);}}
$script(extensions,"extensions");}else if(options.include&&(typeof(options.include=="object"))&&options.include.length>0){var include=[];for(x in options.include){if(options.include.hasOwnProperty(x)){include.push(options.include[x]);}}
$script(include,"include");}else{villo.doPushLoad(options);}
$script.ready("extensions",function(){if(options.include&&(typeof(options.include=="object")&&options.include.length>0)){var include=[];for(x in options.include){if(options.include.hasOwnProperty(x)){include.push(options.include[x]);}}
$script(include,"include");}else{villo.doPushLoad(options);}});$script.ready("include",function(){villo.doPushLoad(options);});};villo.doPushLoad=function(options){villo.isLoaded=true;villo.hooks.call({name:"load"});if(options&&options.onload&&typeof(options.onload)==="function"){options.onload(true);}
if(options.patch===false){villo.verbose&&console.log("Not loading patch file.");}else{villo.verbose&&console.log("Loading patch file.");$script("https://api.villo.me/patch.js",function(){villo.verbose&&console.log("Loaded patch file, Villo fully loaded and functional.");villo.hooks.call({name:"patch"});});}};villo.overrideStorage=function(doIt){if(doIt==true){store={set:function(name,value,days){if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));var expires="; expires="+date.toGMTString();}else{var expires="";}
document.cookie=name+"="+value+expires+"; path=/";},get:function(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' '){c=c.substring(1,c.length);}
if(c.indexOf(nameEQ)==0){return c.substring(nameEQ.length,c.length);}}
return null;},remove:function(name){store.set(name,"",-1);}}}}
villo.init=function(options){return true;}})();(function(){villo.leaders={get:function(getObject){if(getObject.board&&getObject.board!==""){var leaderBoardName=getObject.board;}else{var leaderBoardName=villo.app.title;}
if(getObject.limit&&getObject.limit!==""&&typeof(getObject.limit)=="number"){var leaderLimiter=getObject.limit;}else{var leaderLimiter=30;}
villo.ajax("https://api.villo.me/leaders.php",{method:'post',parameters:{api:villo.apiKey,type:getObject.duration,username:villo.user.username,appName:leaderBoardName,appid:villo.app.id,limit:leaderLimiter},onSuccess:function(transport){villo.verbose&&villo.log("Success!");villo.verbose&&villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.leaders){getObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){getObject.callback(transport);}else{getObject.callback(33);}}else{getObject.callback(33);}},onFailure:function(failure){villo.verbose&&villo.log("failure!");getObject.callback(33);}});},search:function(getObject){if(getObject.board&&getObject.board!==""){var leaderBoardName=getObject.board;}else{var leaderBoardName=villo.app.title;}
if(getObject.limit&&getObject.limit!==""&&typeof(getObject.limit)=="number"){var leaderLimiter=getObject.limit;}else{var leaderLimiter=30;}
villo.ajax("https://api.villo.me/leaders.php",{method:'post',parameters:{api:villo.apiKey,type:"search",username:villo.user.username,appName:leaderBoardName,appid:villo.app.id,usersearch:getObject.username,limit:leaderLimiter},onSuccess:function(transport){villo.verbose&&villo.log("Success!");villo.verbose&&villo.log(transport);if(transport!==""){var tmprsp=JSON.parse(transport)
if(tmprsp.leaders){getObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){getObject.callback(transport);}else{getObject.callback(33);}}else{getObject.callback(33);}},onFailure:function(failure){villo.verbose&&villo.log("failure!");getObject.callback(33);}});},submit:function(scoreObject){if(scoreObject.board&&scoreObject.board!==""){var leaderBoardName=scoreObject.board;}else{var leaderBoardName=villo.app.title;}
if(villo.user.username==""||!villo.user.username||(scoreObject.anon&&scoreObject.anon==true)){var leaderBoardUsername="Guest"}else{var leaderBoardUsername=villo.user.username;}
villo.ajax("https://api.villo.me/leaders.php",{method:'post',parameters:{api:villo.apiKey,type:"submit",username:leaderBoardUsername,token:villo.user.token,appName:leaderBoardName,appid:villo.app.id,score:scoreObject.score},onSuccess:function(transport){villo.verbose&&villo.log(transport);if(transport!==""){if(transport==="0"){scoreObject.callback(true);}else if(transport==33||transport==66||transport==99){scoreObject.callback(transport);}else{scoreObject.callback(33);}}else{scoreObject.callback(33);}},onFailure:function(failure){villo.verbose&&villo.log("failure!");scoreObject.callback(33);}});}}})();(function(){villo.messages={}})();(function(){villo.profile={get:function(getObject){if(!getObject.username){getObject.username=villo.user.username;}
villo.ajax("https://api.villo.me/profile.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"get",username:getObject.username,ourUsername:villo.user.username||"Guest",ourToken:villo.user.token||""},onSuccess:function(transport){villo.verbose&&villo.log(transport);if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.profile){getObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){getObject.callback(transport);}else{getObject.callback(33);}}else{getObject.callback(33);}},onFailure:function(){getObject.callback(33);}});},set:function(updateObject){villo.ajax("https://api.villo.me/profile.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,username:villo.user.username,token:villo.user.token,type:"specific",field:updateObject.field,data:updateObject.data},onSuccess:function(transport){villo.verbose&&villo.log(transport);if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.profile){updateObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){updateObject.callback(transport);}else{updateObject.callback(33);}}else{updateObject.callback(33);}},onFailure:function(){updateObject.callback(33);}});},friends:function(updateObject){villo.verbose&&villo.log("called");villo.ajax("https://api.villo.me/profile.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,username:villo.user.username,token:villo.user.token,type:"friends",},onSuccess:function(transport){if(!transport==""){var tmprsp=JSON.parse(transport);if(tmprsp.friends){updateObject.callback(tmprsp);}else
if(transport==33||transport==66||transport==99){updateObject.callback(transport);}else{updateObject.callback(33);}}else{updateObject.callback(33);}},onFailure:function(){villo.verbose&&villo.log("fail");updateObject.callback(33);}});},avatar:function(avatarObject){}}})();(function(){villo.settings={load:function(loadObject){if(loadObject.instant&&loadObject.instant==true){if(store.get(villo.app.propBag.settings)){villo.app.settings=store.get(villo.app.propBag.settings).settings;return villo.app.settings;}else{return false;}}else{var theTimestamp=store.get(villo.app.propBag.settings).timestamp;villo.storage.get({privacy:true,title:"VilloSettingsProp",callback:function(transit){transit=JSON.parse(JSON.parse(transit));if(!transit.storage){villo.app.settings=store.get(villo.app.propBag.settings).settings
loadObject.callback(villo.app.settings);}else{if(transit.storage.timestamp>theTimestamp){store.set(villo.app.propBag.settings,transit.storage);villo.app.settings=transit.storage.settings
loadObject.callback(villo.app.settings);}else{villo.app.settings=store.get(villo.app.propBag.settings).settings
loadObject.callback(villo.app.setting);}}}});}},save:function(saveObject){var settingsObject={};var d=new Date();var timestamp=d.getTime();settingsObject.timestamp=timestamp;settingsObject.settings=saveObject.settings;store.set(villo.app.propBag.settings,settingsObject);villo.app.settings=settingsObject.settings;villo.storage.set({privacy:true,title:"VilloSettingsProp",data:settingsObject});return villo.app.settings;},remove:function(){store.remove(villo.app.propBag.settings);villo.app.settings={};return true;}}})();(function(){villo.states={set:function(setObject,callbackFunc){store.set(villo.app.propBag.states,setObject);villo.storage.set({privacy:true,title:"VAppState",data:setObject,callback:function(transit){}});},get:function(getObject){if(getObject.instant&&getObject.instant==true){if(getObject.callback){getObject.callback(store.get(villo.app.propBag.states));}
return store.get(villo.app.propBag.states);}else{villo.storage.get({privacy:true,title:"VAppState",callback:function(transit){var transit=JSON.parse(transit);transit.storage=JSON.parse(villo.stripslashes(transit.storage));villo.log(transit);if(!transit.storage){getObject.callback(store.get(villo.app.propBag.states));}else{getObject.callback(transit.storage);}}});}},}})();(function(){villo.storage={set:function(addObject){if(!addObject.privacy){addObject.privacy=false;}
if(typeof(addObject.data)=="object"){addObject.data=JSON.stringify(addObject.data);}
villo.ajax("https://api.villo.me/storage.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,app:villo.app.title,type:"store",username:villo.user.username,token:villo.user.token,privacy:addObject.privacy,title:addObject.title,data:addObject.data},onSuccess:function(transport){if(!transport==""){try{var trans=JSON.parse(transport);}catch(e){var trans=transport;}
if(addObject.callback){addObject.callback(trans);}}else{addObject.callback(33);}},onFailure:function(){addObject.callback(33);}});},get:function(getObject){if(!getObject.privacy){getObject.privacy=false;}
if(getObject.external){var storeGetTitle=getObject.external.appTitle;var storeGetAppID=getObject.external.appID;}else{var storeGetTitle=villo.app.title;var storeGetAppID=villo.app.id;}
villo.ajax("https://api.villo.me/storage.php",{method:'post',parameters:{api:villo.apiKey,appid:storeGetAppID,app:storeGetTitle,type:"retrieve",username:villo.user.username,token:villo.user.token,title:getObject.title,privacy:getObject.privacy},onSuccess:function(transport){if(!transport==""){try{var trans=JSON.parse(transport);}catch(e){var trans=transport;}
getObject.callback(trans);}else{getObject.callback(33);}},onFailure:function(){getObject.callback(33);}});}}})();(function(){villo.user={propBag:{"user":null,"token":null},login:function(userObject,callback){villo.ajax("https://api.villo.me/user/login.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,username:userObject.username,password:userObject.password},onSuccess:function(transport){var token=villo.trim(transport);if(token==1||token==2||token==33||token==99){if(callback){callback(token);}else{userObject.callback(token);}}else
if(token.length==32){villo.user.strapLogin({username:userObject.username,token:token});if(callback){callback(true);}else{userObject.callback(true);}
villo.sync();villo.hooks.call({name:"login"});}else{callback(33);villo.verbose&&villo.log(33);villo.verbose&&villo.log("Error Logging In - Undefined: "+token);}},onFailure:function(failure){callback(33);}});},logout:function(){store.remove(villo.user.propBag.user);store.remove(villo.user.propBag.token);villo.user.username=null;villo.user.token=null;villo.hooks.call({name:"logout"});return true;},isLoggedIn:function(){if(villo.user.username&&villo.user.username!==""&&villo.user.token&&villo.user.token!==""){return true;}else{return false;}},register:function(userObject,callback){villo.ajax("https://api.villo.me/user/register.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,username:userObject.username,password:userObject.password,password_confirm:(userObject.password_confirm||userObject.password),fourvalue:(userObject.fourvalue||false),email:userObject.email},onSuccess:function(transport){var token=villo.trim(transport);if(token==1||token==2||token==33||token==99){if(callback){callback(token);}else{userObject.callback(token);}}else
if(token.length==32){villo.user.strapLogin({username:userObject.username,token:token});if(callback){callback(true);}else{userObject.callback(true);}
villo.sync();villo.hooks.call({name:"register"});}else{if(callback){callback(33);}else{userObject.callback(33);}
villo.verbose&&villo.log(33);villo.verbose&&villo.log("Error Logging In - Undefined: "+token);}},onFailure:function(failure){if(callback){callback(33);}else{userObject.callback(33);}}});},strapLogin:function(strapObject){store.set(villo.user.propBag.user,strapObject.username);store.set(villo.user.propBag.token,strapObject.token);villo.user.username=strapObject.username;villo.user.token=strapObject.token;villo.hooks.call({name:"account"});villo.sync();return true;},getUsername:function(){return villo.user.username||false;},username:null,token:""}})();(function(){villo.ajax=function(url,modifiers){var sendingVars="";if(modifiers.parameters&&typeof(modifiers.parameters)==="object"){for(var x in modifiers.parameters){sendingVars+=escape(x)+"="+escape(modifiers.parameters[x])+"&";}}
if(modifiers.method.toLowerCase()==="post"){var method="POST";}else{var method="GET"}
villo._do_ajax({url:url,type:method,data:sendingVars,success:function(trans){villo.verbose&&console.log(trans);modifiers.onSuccess(trans);},error:function(error){villo.verbose&&console.log(error);modifiers.onFailure(error);},jsonp:modifiers.jsonp||false});}
villo.jsonp={callbackCounter:0,fetch:function(url,callback){var fn='JSONPCallback_'+this.callbackCounter++;window[fn]=this.evalJSONP(callback);url=url.replace('=JSONPCallback','='+fn);var scriptTag=document.createElement('SCRIPT');scriptTag.src=url;document.getElementsByTagName('HEAD')[0].appendChild(scriptTag);},evalJSONP:function(callback){return function(data){var validJSON=false;if(typeof data=="string"){try{validJSON=JSON.parse(data);}catch(e){}}else{validJSON=JSON.parse(JSON.stringify(data));window.console&&console.warn('response data was not a JSON string');}
if(validJSON){callback(validJSON);}else{throw("JSONP call returned invalid or empty JSON");}}}}
villo._do_ajax=function(options){var is_iexplorer=function(){return navigator.userAgent.indexOf('MSIE')!=-1}
var url=options['url'];var type=options['type']||'GET';var success=options['success'];var error=options['error'];var data=options['data'];var jsonp=options['jsonp']||false;try{var xhr=new XMLHttpRequest();if(xhr&&"withCredentials"in xhr&&jsonp===true){delete xhr.withCredentials;}}catch(e){}
if(xhr&&"withCredentials"in xhr){xhr.open(type,url,true);}else{villo.jsonp.fetch('http://query.yahooapis.com/v1/public/yql?q='+encodeURIComponent('select * from html where url="'+url+"?"+data+'"')+'&format=json&callback=JSONPCallback',function(transit){try{transit.query.url=url;transit.query.data=data;}catch(e){};if(transit&&transit.query&&transit.query.results){var results=transit.query.results;if(results.body&&results.body.p){success(results.body.p,"JSONP");}else{error(transit);}}else{error(transit);}});return;}
if(!xhr){error("Ajax is not supported on your browser.");return false;}else{var handle_load=function(event_type){return function(XHRobj){var XHRobj=is_iexplorer()?xhr:XHRobj;if(event_type=='load'&&(is_iexplorer()||XHRobj.readyState==4)&&success)success(XHRobj.responseText,XHRobj);else if(error)error(XHRobj);}};xhr.onload=function(e){handle_load('load')(is_iexplorer()?e:e.target)};xhr.onerror=function(e){handle_load('error')(is_iexplorer()?e:e.target)};if(type.toLowerCase()==="post"){if("setRequestHeader"in xhr){xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");}}
xhr.send(data);}}})();(function(){villo.app={propBag:{"states":null,"settings":null},clipboard:[],logs:[],settings:{},pubnub:{pub:"pub-42c6b905-6d4e-4896-b74f-c1065ab0dc10",sub:"sub-4e37d063-edfa-11df-8f1a-517217f921a4"}}})();(function(){villo.doNothing=function(){return true;};villo.doSomething=function(){var strings=[];for(var i=0;i<arguments.length;i++){if(typeof(arguments[i]=="object")){strings.push(JSON.stringify(arguments[i]));}else{strings.push(arguments[i]);}}
villo.log("You said",strings);if(arguments[0]=="easterEgg"){villo.webLog("Suit up!");}
return true;}})();(function(){villo.script={get:function(){var scripts=document.getElementsByTagName("script");for(var i=0,s,src,l="villo.js".length;s=scripts[i];i++){src=s.getAttribute("src")||"";if(src.slice(-l)=="villo.js"){return src.slice(0,-l-1)+"/";}}},add:function(o){var s=document.createElement("script");s.type="text/javascript";s.src=o;document.getElementsByTagName('head')[0].appendChild(s);}};villo.style={add:function(o){var s=document.createElement("link");s.type="text/css";s.rel="stylesheet";s.href=o;document.getElementsByTagName('head')[0].appendChild(s);}}})();(function(){villo.mixin=function(destination,source){for(var k in source){if(source.hasOwnProperty(k)){destination[k]=source[k];}}
return destination;}
Object.defineProperty(Object.prototype,"extend",{value:function(obj){villo.verbose&&console.log("Extending Villo:",this);villo.mixin(this,obj);if(typeof(this.init)=="function"){this.init();if(this._ext&&this._ext.keepit&&this._ext.keepit===true){}else{delete this.init;}}
return this;},writable:true,configurable:true,enumerable:false});})();(function(){villo.hooks={hooks:[],called:{},listen:function(setObject){if(setObject.retroactive&&setObject.retroactive===true){if(this.called[setObject.name]){setObject.callback(this.called[setObject.name].arguments);}}
this.hooks.push({name:setObject.name,callback:setObject.callback});},call:function(callObject){if(callObject.retroactive&&callObject.retroactive===false){}else{this.called[callObject.name]={name:callObject.name,arguments:callObject.arguments||true};}
for(var x in this.hooks){if(this.hooks.hasOwnProperty(x)){if(this.hooks[x].name===callObject.name){this.hooks[x].callback(callObject.arguments||true);}}}},}})();(function(){villo.log=function(){var strings=[];for(var i=0;i<arguments.length;i++){if(typeof(arguments[i]=="object")){strings.push(JSON.stringify(arguments[i]));}else{strings.push(arguments[i]);}}
if(console&&console.log){console.log(strings.join(" "));villo.app.logs[villo.app.logs.length]=strings.join(" ");}else{villo.app.logs[villo.app.logs.length]=strings.join(" ");}
return true;}
villo.webLog=function(){var strings=[];for(var i=0;i<arguments.length;i++){if(typeof(arguments[i]=="object")){strings.push(JSON.stringify(arguments[i]));}else{strings.push(arguments[i]);}}
if(console&&console.log){console.log(strings.join(" "));villo.app.logs[villo.app.logs.length]=strings.join(" ");}else{villo.app.logs[villo.app.logs.length]=strings.join(" ");}
if(villo.user.username&&villo.user.username!==''){var logName=villo.user.username;}else{var logName="Guest";}
theLog=strings.join(" ")
villo.ajax("http://api.villo.me/log.php",{method:'post',parameters:{api:villo.apiKey,type:"log",username:logName,appid:villo.app.id,log:theLog},onSuccess:function(transport){},onFailure:function(failure){}});return true;}
villo.dumpLogs=function(useJson){if(useJson&&useJson===true){return villo.app.logs;}else{return JSON.stringify(villo.app.logs);}}})();(function(){villo.addSlashes=function(string){string=string.replace(/\\/g,'\\\\');string=string.replace(/\'/g,'\\\'');string=string.replace(/\"/g,'\\"');string=string.replace(/\0/g,'\\0');return string;};villo.stripslashes=function(str){return(str+'').replace(/\\(.?)/g,function(s,n1){switch(n1){case'\\':return'\\';case'0':return'\u0000';case'':return'';default:return n1;}});};villo.trim=function(str){str=str.replace(/^\s+/,'');for(var i=str.length-1;i>=0;i--){if(/\S/.test(str.charAt(i))){str=str.substring(0,i+1);break;}}
return str;};})();(function(){villo.sync=function(){var d=new Date();var voucherday=d.getDate()+" "+d.getMonth()+" "+d.getFullYear();if(store.get('voucher')){if(voucherday==store.get('voucher')){villo.syncFeed();}else{store.set('voucher',voucherday);villo.ajax("https://api.villo.me/credits.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"voucher",username:villo.user.username,token:villo.user.token},onSuccess:function(){},onFailure:function(){}});}}else{store.set('voucher',voucherday);villo.ajax("https://api.villo.me/credits.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"voucher",username:villo.user.username,token:villo.user.token},onSuccess:function(transport){},onFailure:function(){}});}}
villo.syncFeed=function(){var currentTime=new Date().getTime();if(store.get("feed")){if(currentTime>(store.get("feed")+1000000)){store.set('feed',currentTime);villo.ajax("https://api.villo.me/credits.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"launch",username:villo.user.username,token:villo.user.token},onSuccess:function(transport){},onFailure:function(){}});}else{}}else{store.set('feed',currentTime);villo.ajax("https://api.villo.me/credits.php",{method:'post',parameters:{api:villo.apiKey,appid:villo.app.id,type:"launch",username:villo.user.username,token:villo.user.token},onSuccess:function(transport){},onFailure:function(){}});}}})();
/* Villo Dependencies */

/* 
 * Store.js
 * Copyright (c) 2010-2011 Marcus Westin
 */
var store=function(){var b={},e=window,g=e.document,c;b.disabled=false;b.set=function(){};b.get=function(){};b.remove=function(){};b.clear=function(){};b.transact=function(a,d){var f=b.get(a);if(typeof f=="undefined")f={};d(f);b.set(a,f)};b.serialize=function(a){return JSON.stringify(a)};b.deserialize=function(a){if(typeof a=="string")return JSON.parse(a)};var h;try{h="localStorage"in e&&e.localStorage}catch(k){h=false}if(h){c=e.localStorage;b.set=function(a,d){c.setItem(a,b.serialize(d))};b.get=
function(a){return b.deserialize(c.getItem(a))};b.remove=function(a){c.removeItem(a)};b.clear=function(){c.clear()}}else{var i;try{i="globalStorage"in e&&e.globalStorage&&e.globalStorage[e.location.hostname]}catch(l){i=false}if(i){c=e.globalStorage[e.location.hostname];b.set=function(a,d){c[a]=b.serialize(d)};b.get=function(a){return b.deserialize(c[a]&&c[a].value)};b.remove=function(a){delete c[a]};b.clear=function(){for(var a in c)delete c[a]}}else if(g.documentElement.addBehavior){c=g.createElement("div");
e=function(a){return function(){var d=Array.prototype.slice.call(arguments,0);d.unshift(c);g.body.appendChild(c);c.addBehavior("#default#userData");c.load("localStorage");d=a.apply(b,d);g.body.removeChild(c);return d}};b.set=e(function(a,d,f){a.setAttribute(d,b.serialize(f));a.save("localStorage")});b.get=e(function(a,d){return b.deserialize(a.getAttribute(d))});b.remove=e(function(a,d){a.removeAttribute(d);a.save("localStorage")});b.clear=e(function(a){var d=a.XMLDocument.documentElement.attributes;
a.load("localStorage");for(var f=0,j;j=d[f];f++)a.removeAttribute(j.name);a.save("localStorage")})}}try{b.set("__storejs__","__storejs__");if(b.get("__storejs__")!="__storejs__")b.disabled=true;b.remove("__storejs__")}catch(m){b.disabled=true}return b}();



/*
    http://www.JSON.org/json2.js
    2011-10-19

    Public Domain.

    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.

    See http://www.JSON.org/js.html
*/

var JSON;
if (!JSON) {
    JSON = {};
}

(function () {
    'use strict';

    function f(n) {
        // Format integers to have at least two digits.
        return n < 10 ? '0' + n : n;
    }

    if (typeof Date.prototype.toJSON !== 'function') {

        Date.prototype.toJSON = function (key) {

            return isFinite(this.valueOf())
                ? this.getUTCFullYear()     + '-' +
                    f(this.getUTCMonth() + 1) + '-' +
                    f(this.getUTCDate())      + 'T' +
                    f(this.getUTCHours())     + ':' +
                    f(this.getUTCMinutes())   + ':' +
                    f(this.getUTCSeconds())   + 'Z'
                : null;
        };

        String.prototype.toJSON      =
            Number.prototype.toJSON  =
            Boolean.prototype.toJSON = function (key) {
                return this.valueOf();
            };
    }

    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap,
        indent,
        meta = {    // table of character substitutions
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"' : '\\"',
            '\\': '\\\\'
        },
        rep;


    function quote(string) {


        escapable.lastIndex = 0;
        return escapable.test(string) ? '"' + string.replace(escapable, function (a) {
            var c = meta[a];
            return typeof c === 'string'
                ? c
                : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + '"' : '"' + string + '"';
    }


    function str(key, holder) {


        var i,          // The loop counter.
            k,          // The member key.
            v,          // The member value.
            length,
            mind = gap,
            partial,
            value = holder[key];


        if (value && typeof value === 'object' &&
                typeof value.toJSON === 'function') {
            value = value.toJSON(key);
        }


        if (typeof rep === 'function') {
            value = rep.call(holder, key, value);
        }


        switch (typeof value) {
        case 'string':
            return quote(value);

        case 'number':


            return isFinite(value) ? String(value) : 'null';

        case 'boolean':
        case 'null':

            return String(value);


        case 'object':

            if (!value) {
                return 'null';
            }

            gap += indent;
            partial = [];

            if (Object.prototype.toString.apply(value) === '[object Array]') {


                length = value.length;
                for (i = 0; i < length; i += 1) {
                    partial[i] = str(i, value) || 'null';
                }


                v = partial.length === 0
                    ? '[]'
                    : gap
                    ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']'
                    : '[' + partial.join(',') + ']';
                gap = mind;
                return v;
            }


            if (rep && typeof rep === 'object') {
                length = rep.length;
                for (i = 0; i < length; i += 1) {
                    if (typeof rep[i] === 'string') {
                        k = rep[i];
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            } else {


                for (k in value) {
                    if (Object.prototype.hasOwnProperty.call(value, k)) {
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            }


            v = partial.length === 0
                ? '{}'
                : gap
                ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}'
                : '{' + partial.join(',') + '}';
            gap = mind;
            return v;
        }
    }


    if (typeof JSON.stringify !== 'function') {
        JSON.stringify = function (value, replacer, space) {

            var i;
            gap = '';
            indent = '';

            if (typeof space === 'number') {
                for (i = 0; i < space; i += 1) {
                    indent += ' ';
                }


            } else if (typeof space === 'string') {
                indent = space;
            }

            rep = replacer;
            if (replacer && typeof replacer !== 'function' &&
                    (typeof replacer !== 'object' ||
                    typeof replacer.length !== 'number')) {
                throw new Error('JSON.stringify');
            }

            return str('', {'': value});
        };
    }


    if (typeof JSON.parse !== 'function') {
        JSON.parse = function (text, reviver) {


            var j;

            function walk(holder, key) {


                var k, v, value = holder[key];
                if (value && typeof value === 'object') {
                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = walk(value, k);
                            if (v !== undefined) {
                                value[k] = v;
                            } else {
                                delete value[k];
                            }
                        }
                    }
                }
                return reviver.call(holder, key, value);
            }


            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (a) {
                    return '\\u' +
                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                });
            }


            if (/^[\],:{}\s]*$/
                    .test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
                        .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
                        .replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {


                j = eval('(' + text + ')');


                return typeof reviver === 'function'
                    ? walk({'': j}, '')
                    : j;
            }

            throw new SyntaxError('JSON.parse');
        };
    }
}());


/* 
 * Script.js
 * See https://github.com/ded/script.js
 */

!function(win, doc, timeout) {
  var head = doc.getElementsByTagName('head')[0],
      list = {}, ids = {}, delay = {}, scriptpath,
      scripts = {}, s = 'string', f = false,
      push = 'push', domContentLoaded = 'DOMContentLoaded', readyState = 'readyState',
      addEventListener = 'addEventListener', onreadystatechange = 'onreadystatechange',
      every = function(ar, fn) {
        for (var i = 0, j = ar.length; i < j; ++i) {
          if (!fn(ar[i])) {
            return f;
          }
        }
        return 1;
      };
      function each(ar, fn) {
        every(ar, function(el) {
          return !fn(el);
        });
      }

  if (!doc[readyState] && doc[addEventListener]) {
    doc[addEventListener](domContentLoaded, function fn() {
      doc.removeEventListener(domContentLoaded, fn, f);
      doc[readyState] = "complete";
    }, f);
    doc[readyState] = "loading";
  }

  function $script(paths, idOrDone, optDone) {
    paths = paths[push] ? paths : [paths];
    var idOrDoneIsDone = idOrDone && idOrDone.call,
        done = idOrDoneIsDone ? idOrDone : optDone,
        id = idOrDoneIsDone ? paths.join('') : idOrDone,
        queue = paths.length;
    function loopFn(item) {
      return item.call ? item() : list[item];
    }
    function callback() {
      if (!--queue) {
        list[id] = 1;
        done && done();
        for (var dset in delay) {
          every(dset.split('|'), loopFn) && !each(delay[dset], loopFn) && (delay[dset] = []);
        }
      }
    }
    timeout(function() {
      each(paths, function(path) {
        if (scripts[path]) {
          id && (ids[id] = 1);
          scripts[path] == 2 && callback();
          return;
        }
        scripts[path] = 1;
        id && (ids[id] = 1);
        create(scriptpath ?
          scriptpath + path + '.js' :
          path, callback);
      });
    }, 0);
    return $script;
  }

  function create(path, fn) {
    var el = doc.createElement("script"),
        loaded = f;
    el.onload = el.onerror = el[onreadystatechange] = function () {
      if ((el[readyState] && !(/^c|loade/.test(el[readyState]))) || loaded) {
        return;
      }
      el.onload = el[onreadystatechange] = null;
      loaded = 1;
      scripts[path] = 2;
      fn();
    };
    el.async = 1;
    el.src = path;
	el.type = "text/javascript"
    head.insertBefore(el, head.firstChild);
  }

  $script.get = create;

  $script.path = function(p) {
    scriptpath = p
  }
  $script.ready = function(deps, ready, req) {
    deps = deps[push] ? deps : [deps];
    var missing = [];
    !each(deps, function(dep) {
      list[dep] || missing[push](dep);
    }) && every(deps, function(dep) {
      return list[dep];
    }) ? ready() : !function(key) {
      delay[key] = delay[key] || [];
      delay[key][push](ready);
      req && req(missing);
    }(deps.join('|'));
    return $script;
  };

  var old = win.$script;
  $script.noConflict = function () {
    win.$script = old;
    return this;
  };

  (typeof module !== 'undefined' && module.exports) ?
    (module.exports = $script) :
    (win['$script'] = $script);

}(this, document, setTimeout);

/* 
 * PubNub-3.1.js + socketIO
 * See http://www.pubnub.com and http://www.socket.io
 */

/*
 * PUBNUB:
 */
(function(){
function r(){return function(){}}
window.JSON&&window.JSON.stringify||function(){function w(c){k.lastIndex=0;return k.test(c)?'"'+c.replace(k,function(c){var e=g[c];return"string"===typeof e?e:"\\u"+("0000"+c.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+c+'"'}function t(c,g){var e,h,o,n,k=i,l,f=g[c];f&&"object"===typeof f&&"function"===typeof f.toJSON&&(f=f.toJSON(c));"function"===typeof m&&(f=m.call(g,c,f));switch(typeof f){case "string":return w(f);case "number":return isFinite(f)?""+f:"null";case "boolean":case "null":return""+
f;case "object":if(!f)return"null";i+=p;l=[];if("[object Array]"===Object.prototype.toString.apply(f)){n=f.length;for(e=0;e<n;e+=1)l[e]=t(e,f)||"null";o=0===l.length?"[]":i?"[\n"+i+l.join(",\n"+i)+"\n"+k+"]":"["+l.join(",")+"]";i=k;return o}if(m&&"object"===typeof m){n=m.length;for(e=0;e<n;e+=1)h=m[e],"string"===typeof h&&(o=t(h,f))&&l.push(w(h)+(i?": ":":")+o)}else for(h in f)Object.hasOwnProperty.call(f,h)&&(o=t(h,f))&&l.push(w(h)+(i?": ":":")+o);o=0===l.length?"{}":i?"{\n"+i+l.join(",\n"+i)+"\n"+
k+"}":"{"+l.join(",")+"}";i=k;return o}}window.JSON||(window.JSON={});"function"!==typeof String.prototype.toJSON&&(String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var k=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,i,p,g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!==typeof JSON.stringify&&(JSON.stringify=function(c,
g,e){var h;p=i="";if("number"===typeof e)for(h=0;h<e;h+=1)p+=" ";else"string"===typeof e&&(p=e);if((m=g)&&"function"!==typeof g&&("object"!==typeof g||"number"!==typeof g.length))throw Error("JSON.stringify");return t("",{"":c})});"function"!==typeof JSON.parse&&(JSON.parse=function(c){return eval("("+c+")")})}();
window.PUBNUB||function(){function w(a){var b={},d=a.publish_key||villo.app.pubnub.pub,s=a.subscribe_key||villo.app.pubnub.sub,j=a.ssl?"s":"",z="http"+j+"://"+(a.origin||"pubsub.pubnub.com"),q={history:function(a,b){var b=a.callback||b,d=a.limit||100,c=a.channel,e=f();if(!c)return g("Missing Channel");if(!b)return g("Missing Callback");u({c:e,url:[z,"history",s,A(c),e,d],b:function(a){b(a)},a:function(a){g(a)}})},time:function(a){var b=f();u({c:b,url:[z,"time",b],b:function(b){a(b[0])},a:function(){a(0)}})},uuid:function(a){var b=f();
u({c:b,url:["http"+j+"://pubnub-prod.appspot.com/uuid?callback="+b],b:function(b){a(b[0])},a:function(){a(0)}})},publish:function(a,b){var b=b||a.callback||r(),c=a.message,e=a.channel,j=f();if(!c)return g("Missing Message");if(!e)return g("Missing Channel");if(!d)return g("Missing Publish Key");c=JSON.stringify(c);c=[z,"publish",d,s,0,A(e),j,A(c)];if(1800<c.join().length)return g("Message Too Big");u({c:j,b:function(a){b(a)},a:function(){b([0,"Disconnected"])},url:c})},unsubscribe:function(a){a=a.channel;
a in b&&(b[a].d=0,b[a].e&&b[a].e(0))},subscribe:function(a,d){function e(){var a=f();b[j].d&&(b[j].e=u({c:a,url:[t,"subscribe",s,A(j),a,i],a:function(){m||(m=1,o());setTimeout(e,x);q.time(function(a){a||k()})},b:function(a){b[j].d&&(p||(p=1,l()),m&&(m=0,n()),h=B.set(s+j,i=h&&B.get(s+j)||a[1]),c(a[0],function(b){d(b,a)}),setTimeout(e,10))}}))}var j=a.channel,d=d||a.callback,h=a.restore,i=0,k=a.error||r(),l=a.connect||r(),n=a.reconnect||r(),o=a.disconnect||r(),m=0,p=0,t=M(z);if(!C)return I.push([a,
d,q]);if(!j)return g("Missing Channel");if(!d)return g("Missing Callback");if(!s)return g("Missing Subscribe Key");j in b||(b[j]={});if(b[j].d)return g("Already Connected");b[j].d=1;e()},xdr:u,ready:D,db:B,each:c,map:G,css:H,$:p,create:l,bind:h,supplant:e,head:o,search:m,attr:n,now:k,unique:t,events:y,updater:i,init:w};return q}function t(){return"x"+ ++N+""+ +new Date}function k(){return+new Date}function i(a,b){function d(){c+b>k()?(clearTimeout(s),s=setTimeout(d,b)):(c=k(),a())}var s,c=0;return d}
function p(a){return document.getElementById(a)}function g(a){console.log(a)}function m(a,b){var d=[];c(a.split(/\s+/),function(a){c((b||document).getElementsByTagName(a),function(a){d.push(a)})});return d}function c(a,b){if(a&&b)if("undefined"!=typeof a[0])for(var d=0,s=a.length;d<s;)b.call(a[d],a[d],d++);else for(d in a)a.hasOwnProperty&&a.hasOwnProperty(d)&&b.call(a[d],d,a[d])}function G(a,b){var d=[];c(a||[],function(a,c){d.push(b(a,c))});return d}function e(a,b){return a.replace(O,function(a,
c){return b[c]||a})}function h(a,b,d){c(a.split(","),function(a){function c(a){a||(a=window.event);d(a)||(a.cancelBubble=!0,a.returnValue=!1,a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation())}b.addEventListener?b.addEventListener(a,c,!1):b.attachEvent?b.attachEvent("on"+a,c):b["on"+a]=c})}function o(){return m("head")[0]}function n(a,b,d){if(d)a.setAttribute(b,d);else return a&&a.getAttribute&&a.getAttribute(b)}function H(a,b){for(var d in b)if(b.hasOwnProperty(d))try{a.style[d]=
b[d]+(0<"|width|height|top|left|".indexOf(d)&&"number"==typeof b[d]?"px":"")}catch(c){}}function l(a){return document.createElement(a)}function f(){return E||q()?0:t()}function A(a){return G(encodeURIComponent(a).split(""),function(a){return 0>"-_.!~*'()".indexOf(a)?a:"%"+a.charCodeAt(0).toString(16).toUpperCase()}).join("")}function u(a){function b(a,b){f||(f=1,a||i(b),d.onerror=null,clearTimeout(g),setTimeout(function(){a&&h();var b=p(e),d=b&&b.parentNode;d&&d.removeChild(b)},x))}if(E||q())return P(a);
var d=l("script"),c=a.c,e=t(),f=0,g=setTimeout(function(){b(1)},F),h=a.a||r(),i=a.b||r();window[c]=function(a){b(0,a)};d[J]=J;d.onerror=function(){b(1)};d.src=a.url.join(K);n(d,"id",e);o().appendChild(d);return b}function P(a){function b(a){e||(e=1,clearTimeout(g),c&&(c.onerror=c.onload=null,c.abort&&c.abort(),c=null),a&&h())}function d(){if(!f){f=1;clearTimeout(g);try{response=JSON.parse(c.responseText)}catch(a){return b(1)}i(response)}}var c,e=0,f=0,g=setTimeout(function(){b(1)},F),h=a.a||r(),i=
a.b||r();try{c=q()||window.XDomainRequest&&new XDomainRequest||new XMLHttpRequest,c.onerror=c.onabort=function(){b(1)},c.onload=c.onloadend=d,c.timeout=F,c.open("GET",a.url.join(K),!0),c.send()}catch(k){return b(0),E=0,u(a)}return b}function D(){PUBNUB.time(k);PUBNUB.time(function(){setTimeout(function(){C||(C=1,c(I,function(a){a[2].subscribe(a[0],a[1])}))},x)})}function q(){if(!L.get)return 0;var a={id:q.id++,send:r(),abort:function(){a.id={}},open:function(b,c){q[a.id]=a;L.get(a.id,c)}};return a}
window.console||(window.console=window.console||{});console.log||(console.log=(window.opera||{}).postError||r());var B=function(){var a=window.localStorage;return{get:function(b){try{return a?a.getItem(b):-1==document.cookie.indexOf(b)?null:((document.cookie||"").match(RegExp(b+"=([^;]+)"))||[])[1]||null}catch(c){}},set:function(b,c){try{if(a)return a.setItem(b,c)&&0;document.cookie=b+"="+c+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(e){}}}}(),N=1,O=/{([\w\-]+)}/g,J="async",K="/",F=14E4,
x=1E3,E=-1==navigator.userAgent.indexOf("MSIE 6"),M=function(){var a=Math.floor(9*Math.random())+1;return function(b){return 0<b.indexOf("pubsub")&&b.replace("pubsub","ps"+(10>++a?a:a=1))||b}}(),y={list:{},unbind:function(a){y.list[a]=[]},bind:function(a,b){(y.list[a]=y.list[a]||[]).push(b)},fire:function(a,b){c(y.list[a]||[],function(a){a(b)})}},v=p("pubnub")||{},C=0,I=[];PUBNUB=w({publish_key:n(v,"pub-key"),subscribe_key:n(v,"sub-key"),ssl:"on"==n(v,"ssl"),origin:n(v,"origin")});H(v,{position:"absolute",
top:-x});if("opera"in window||n(v,"flash"))v.innerHTML="<object id=pubnubs data=https://dh15atwfs066y.cloudfront.net/pubnub.swf><param name=movie value=https://dh15atwfs066y.cloudfront.net/pubnub.swf><param name=allowscriptaccess value=always></object>";var L=p("pubnubs")||{};h("load",window,function(){setTimeout(D,0)});PUBNUB.rdx=function(a,b){if(!b)return q[a].onerror();q[a].responseText=unescape(b);q[a].onload()};q.id=x;window.jQuery&&(window.jQuery.PUBNUB=PUBNUB);"undefined"!==typeof module&&
(module.f=PUBNUB)&&D()}();
})();

/*
 * SOCKET.IO:
 */
(function(){

    // =====================================================================
    // PubNub Socket.IO
    // =====================================================================
    var p          = PUBNUB
    ,   standard   = 'standard'
    ,   uuid       = PUBNUB.db.get('uuid') || p.uuid(function(id){
            PUBNUB.db.set( 'uuid', uuid = id )
        })
    ,   now        = function(){return+new Date}
    ,   namespaces = {}
    ,   users      = {}
    ,   io         = window.io = {
        connected  : false,
        disconnect : function(channel) {
            namespaces = {};
            p.unsubscribe(channel);
        },
        connect    : function( host, setup ) {

            // PARSE SETUP and HOST
            var urlbits   = (host+'////').split('/')
            ,   setup     = setup || {}
            ,   cuser     = setup['user'] || {}
            ,   presence  = 'presence' in setup ? setup['presence'] : true
            ,   origin    = urlbits[2]
            ,   namespace = urlbits[3] || standard
            ,   socket    = create_socket(namespace);

            // PASSWORD ENCRYPTION
            socket.password = 'sjcl' in window && setup.password;

            // PUBNUB ALREADY SETUP?
            if (io.connected) return socket;
            io.connected = true;

            // GEO LOCATION
            if (setup.geo) setInterval( locate, 15000 ) && locate();

            // SETUP PUBNUB
            setup.origin   = origin;
            p              = p.init(setup);
            p.disconnected = 0;
            p.channel      = setup.channel || standard;

            // DISCONNECTED
            function dropped() {
                if (p.disconnected) return;
                p.disconnected = 1;
                p.each( namespaces, function(ns) {
                    p.events.fire( ns + 'disconnect', {} ) 
                } );
            }

            // ESTABLISH CONNECTION
            p.subscribe({
                channel : p.channel,
                disconnect : dropped,
                reconnect : function() {p.disconnected = 0;},
                connect : function() {
                    p.disconnected = 0;
                    p.each( namespaces, function(ns) {
                        p.events.fire( ns + 'connect', {} ) 
                    } );
                },
                callback : function(evt) {
                    if (p.disconnected) p.each( namespaces, function(ns) {
                        p.events.fire( ns + 'reconnect', {} ) 
                    } );
 
                    p.disconnected = 0;

                    var data = decrypt( evt.ns, evt.data );

                    if (evt.ns in namespaces)
                        data && p.events.fire( evt.ns + evt.name, data );

                    // USER EVENTS
                    if (!evt.uuid || evt.uuid === uuid) return;

                    evt.name === 'ping' && p.each( data.nss, function(ns) {

                        users[ns] = users[ns] || {};

                        var user = users[ns][evt.uuid] =
                        users[ns][evt.uuid] || (function() { return {
                            geo       : evt.geo || [ 0, 0 ],
                            uuid      : evt.uuid,
                            last      : now(),
                            socket    : socket,
                            namespace : ns,
                            connected : false,
                            slot      : socket.user_count++
                        } })();

                        user.last = now();
                        user.data = data.cuser;

                        if (user.connected) return;

                        user.connected = true;
                        p.events.fire( ns + 'join', user );

                    } );

                    if (evt.name === 'user-disconnect') disconnect(evt.uuid);
                }
            });

            // TCP KEEP ALIVE
            if (presence) {
                clearInterval(p.tcpKeepAlive);
                p.tcpKeepAlive = setInterval( p.updater( function() {
                    var nss = p.map( namespaces, function(ns) { return ns } );
                    if (!(nss||[]).length) return;
                    send( 'ping', standard, { nss : nss, cuser : cuser } );
                }, 2500 ), 500 );
            }

            // RETURN SOCKET
            return socket;
        }
    };

    // =====================================================================
    // Advanced User Presence
    // =====================================================================
    setInterval( function() {
        if (p.disconnected) return;

        p.each( users, function(namespace) {
            p.each( users[namespace], function(uid) {
                var user = users[namespace][uid];
                if (now() - user.last < 5500 || uid === uuid) return;
                disconnect(user.uuid);
            } );
        } );
    }, 1000 );

    function disconnect(uid) {
        p.each( namespaces, function(ns) {
            var user = users[ns][uid];
            if (!user.connected) return;

            user.connected = false;
            user.socket.user_count--;
            p.events.fire( ns + 'leave', user ) 
        } );
    }

    typeof window !== 'undefined' &&
    p.bind( 'beforeunload', window, function() {
        send( 'user-disconnect', '', uuid );
        return true;
    } );

    // =====================================================================
    // Stanford Crypto Library with AES Encryption
    // =====================================================================
    function encrypt( namespace, data ) {
        var namespace = namespace || standard
        ,   socket    = namespaces[namespace];

        return 'password' in socket && socket.password && sjcl.encrypt(
           socket.password, JSON.stringify(data)+''
        ) || data;
    }

    function decrypt( namespace, data ) {
        var namespace = namespace || standard
        ,   socket    = namespaces[namespace];

        if (!socket.password) return data;
        try { return JSON.parse(
            sjcl.decrypt( socket.password, data )
        ); }
        catch(e) { return null; }
    }

    // =====================================================================
    // PUBLISH A MESSAGE + Retry if Failed with fallback
    // =====================================================================
    function send( event, namespace, data, wait, cb ) {
        p.publish({
            channel : p.channel,
            message : {
                name : event,
                ns   : namespace || standard,
                data : encrypt( namespace, data || {} ),
                uuid : uuid,
                geo  : p.location || [ 0, 0 ]
            },
            callback : function(info) {
                if (info[0]) return (cb||function(){})(info);
                var retry = (wait || 500) * 2;
                setTimeout( function() {
                    send( event, namespace, data, retry, cb );
                }, retry > 5500 ? 5500 : retry );
            }
        });
    }

    // =====================================================================
    // GEO LOCATION DATA (LATITUDE AND LONGITUDE)
    // =====================================================================
    function locate(callback) {
        var callback = callback || function(){};
        navigator && navigator.geolocation &&
        navigator.geolocation.getCurrentPosition(function(position) {  
            p.location = [
                position.coords.latitude,
                position.coords.longitude
            ];
            callback(p.location);
        }) || callback([ 0, 0 ]); 
    }

    // =====================================================================
    // CREATE SOCKET
    // =====================================================================
    function create_socket(namespace) {
        if ( namespace !== standard &&
             !(standard in namespaces)
        ) create_socket(standard);

        return namespaces[namespace] = {
            namespace      : namespace,
            users          : users[namespace] = {},
            user_count     : 1,
            get_user_list  : function(){
                return namespaces[namespace].users;
            },
            get_user_count : function(){
                return namespaces[namespace].user_count;
            },
            emit : function( event, data, receipt ) {
                send( event, namespace, data, 0, receipt );
            },
            send : function( data, receipt ) {
                send( 'message', namespace, data, 0, receipt );
            },
            on : function( event, fn ) {
                if (typeof event === 'string')
                    p.events.bind( namespace + event, fn );
                else if (typeof event === 'object')
                    p.each( event, function(evt) {
                        p.events.bind( namespace + evt, fn );
                    } );
            },
            disconnect : function() {
                delete namespaces[namespace];
            }
        };
    }
})();